name: Advanced Testing Matrix

on:
  schedule:
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  frontend-matrix:
    name: Frontend Tests (Matrix)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16, 18, 20]
        browser: [chromium, firefox]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm install

    - name: Install Playwright
      run: |
        cd frontend
        npx playwright install ${{ matrix.browser }}

    - name: Prepare test-results folder
      run: mkdir -p frontend/tests/test-results

    - name: Run tests with ${{ matrix.browser }}
      run: |
        cd frontend
        BROWSER=${{ matrix.browser }} npx cucumber-js tests/features/ \
          --require-module ts-node/register \
          --require "tests/step-definitions/**/*.ts" \
          --format json:tests/test-results/results.json \
          --format progress \
          --world-parameters "{\"headless\": true}

    - name: Upload frontend test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-test-results-${{ matrix.browser }}-node${{ matrix.node-version }}
        path: frontend/tests/test-results/

    - name: Add summary to GitHub Actions
      if: always()
      run: |
        echo "### 🧪 Frontend Tests Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Node version: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Browser: ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "- Results stored in: frontend/tests/test-results/results.json" >> $GITHUB_STEP_SUMMARY

  backend-performance:
    name: Backend Performance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup k6
      uses: grafana/setup-k6-action@v1

    - name: Run performance tests
      run: |
        cd backend
        mkdir -p results
        k6 run tests/performance.test.js --out json=results/performance-results.json || echo "k6 test run completed with warnings"

    - name: Upload performance results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-performance-results
        path: backend/results/performance-results.json

    - name: Add summary to GitHub Actions
      if: always()
      run: |
        echo "### ⚙️ Backend Performance Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Test file: backend/tests/performance.test.js" >> $GITHUB_STEP_SUMMARY
        echo "- Results stored in: backend/results/performance-results.json" >> $GITHUB_STEP_SUMMARY
